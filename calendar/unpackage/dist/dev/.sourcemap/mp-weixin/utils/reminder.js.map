{"version":3,"file":"reminder.js","sources":["utils/reminder.js"],"sourcesContent":["class ReminderService {\n  constructor() {\n    this.initialized = false\n  }\n\n  // ÂàùÂßãÂåñÊèêÈÜíÊúçÂä°\n  async init() {\n    if (this.initialized) return\n    \n    try {\n      // #ifdef APP-PLUS\n      // Áî≥ËØ∑ÈÄöÁü•ÊùÉÈôê\n      const result = await plus.push.requestPermission()\n      if (result) {\n        console.log('‚úÖ ÈÄöÁü•ÊùÉÈôêÁî≥ËØ∑ÊàêÂäü')\n      } else {\n        console.warn('‚ö†Ô∏è ÈÄöÁü•ÊùÉÈôêÁî≥ËØ∑Â§±Ë¥•')\n      }\n      // #endif\n      \n      this.initialized = true\n    } catch (error) {\n      console.error('‚ùå ÊèêÈÜíÊúçÂä°ÂàùÂßãÂåñÂ§±Ë¥•:', error)\n    }\n  }\n\n  // ÂàõÂª∫Êú¨Âú∞ÈÄöÁü•\n  createLocalNotification(event) {\n    return new Promise((resolve, reject) => {\n      // #ifdef APP-PLUS\n      if (!plus.push) {\n        reject(new Error('Êé®ÈÄÅÂäüËÉΩ‰∏çÂèØÁî®'))\n        return\n      }\n\n      const options = {\n        title: 'Êó•Á®ãÊèêÈÜí',\n        content: `${event.title} Âç≥Â∞ÜÂºÄÂßã`,\n        cover: false,\n        sound: 'system',\n        icon: '/static/logo.png'\n      }\n\n      // ËÆ°ÁÆóÊèêÈÜíÊó∂Èó¥\n      const reminderTime = this.calculateReminderTime(event)\n      if (reminderTime > Date.now()) {\n        options.when = reminderTime\n      }\n\n      plus.push.createMessage(options.content, options.payload, options)\n      console.log('üìÖ ÂàõÂª∫Êú¨Âú∞ÈÄöÁü•:', event.title, new Date(reminderTime))\n      resolve()\n      // #endif\n      \n      // #ifdef H5\n      this.createH5Notification(event)\n        .then(resolve)\n        .catch(reject)\n      // #endif\n    })\n  }\n\n  // H5ÁéØÂ¢É‰∏ãÁöÑÈÄöÁü•\n  async createH5Notification(event) {\n    if (!('Notification' in window)) {\n      throw new Error('ÊµèËßàÂô®‰∏çÊîØÊåÅÈÄöÁü•ÂäüËÉΩ')\n    }\n\n    if (Notification.permission === 'default') {\n      await Notification.requestPermission()\n    }\n\n    if (Notification.permission === 'granted') {\n      const reminderTime = this.calculateReminderTime(event) - Date.now()\n      \n      if (reminderTime > 0) {\n        setTimeout(() => {\n          const notification = new Notification('Êó•Á®ãÊèêÈÜí', {\n            body: `${event.title} Âç≥Â∞ÜÂºÄÂßã`,\n            icon: '/static/logo.png',\n            tag: event._id\n          })\n          \n          notification.onclick = function() {\n            window.focus()\n            notification.close()\n          }\n        }, reminderTime)\n      }\n    }\n  }\n\n  // ËÆ°ÁÆóÊèêÈÜíÊó∂Èó¥\n  calculateReminderTime(event) {\n    const startDateTime = new Date(`${event.startDate} ${event.startTime || '00:00'}`)\n    \n    // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊèêÈÜíËÆæÁΩÆÔºåÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂàôÈªòËÆ§ÊèêÂâç15ÂàÜÈíü\n    const reminderMinutes = event.reminders && event.reminders.length > 0 \n      ? event.reminders[0] \n      : 15\n    \n    return startDateTime.getTime() - (reminderMinutes * 60 * 1000)\n  }\n\n  // ÂèñÊ∂àÈÄöÁü•\n  cancelNotification(eventId) {\n    // #ifdef APP-PLUS\n    // Ê∏ÖÈô§ÊâÄÊúâÈÄöÁü•\n    plus.push.clear()\n    console.log('üóëÔ∏è Ê∏ÖÈô§ÈÄöÁü•:', eventId)\n    // #endif\n    \n    // #ifdef H5\n    // H5ÁéØÂ¢É‰∏ãÊó†Ê≥ïÁõ¥Êé•ÂèñÊ∂àÁâπÂÆöÈÄöÁü•\n    // #endif\n  }\n\n  // Ê£ÄÊü•Âπ∂ËÆæÁΩÆÊèêÈÜí\n  async scheduleEventReminders(events) {\n    await this.init()\n    \n    const now = Date.now()\n    const futureEvents = events.filter(event => {\n      const eventTime = new Date(`${event.startDate} ${event.startTime || '00:00'}`).getTime()\n      return eventTime > now && !event.hasReminded\n    })\n\n    for (const event of futureEvents) {\n      try {\n        await this.createLocalNotification(event)\n      } catch (error) {\n        console.error('‚ùå ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•:', event.title, error)\n      }\n    }\n  }\n}\n\nexport default new ReminderService()"],"names":["uni"],"mappings":";;AAAA,MAAM,gBAAgB;AAAA,EACpB,cAAc;AACZ,SAAK,cAAc;AAAA,EACpB;AAAA;AAAA,EAGD,MAAM,OAAO;AACX,QAAI,KAAK;AAAa;AAEtB,QAAI;AAWF,WAAK,cAAc;AAAA,IACpB,SAAQ,OAAO;AACdA,oBAAAA,MAAc,MAAA,SAAA,2BAAA,gBAAgB,KAAK;AAAA,IACpC;AAAA,EACF;AAAA;AAAA,EAGD,wBAAwB,OAAO;AAC7B,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAAA,IA+B5C,CAAK;AAAA,EACF;AAAA;AAAA,EAGD,MAAM,qBAAqB,OAAO;AAChC,QAAI,EAAE,kBAAkB,SAAS;AAC/B,YAAM,IAAI,MAAM,YAAY;AAAA,IAC7B;AAED,QAAI,aAAa,eAAe,WAAW;AACzC,YAAM,aAAa,kBAAmB;AAAA,IACvC;AAED,QAAI,aAAa,eAAe,WAAW;AACzC,YAAM,eAAe,KAAK,sBAAsB,KAAK,IAAI,KAAK,IAAK;AAEnE,UAAI,eAAe,GAAG;AACpB,mBAAW,MAAM;AACf,gBAAM,eAAe,IAAI,aAAa,QAAQ;AAAA,YAC5C,MAAM,GAAG,MAAM,KAAK;AAAA,YACpB,MAAM;AAAA,YACN,KAAK,MAAM;AAAA,UACvB,CAAW;AAED,uBAAa,UAAU,WAAW;AAChC,mBAAO,MAAO;AACd,yBAAa,MAAO;AAAA,UACrB;AAAA,QACF,GAAE,YAAY;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAAA;AAAA,EAGD,sBAAsB,OAAO;AAC3B,UAAM,gBAAgB,oBAAI,KAAK,GAAG,MAAM,SAAS,IAAI,MAAM,aAAa,OAAO,EAAE;AAGjF,UAAM,kBAAkB,MAAM,aAAa,MAAM,UAAU,SAAS,IAChE,MAAM,UAAU,CAAC,IACjB;AAEJ,WAAO,cAAc,QAAO,IAAM,kBAAkB,KAAK;AAAA,EAC1D;AAAA;AAAA,EAGD,mBAAmB,SAAS;AAAA,EAU3B;AAAA;AAAA,EAGD,MAAM,uBAAuB,QAAQ;AACnC,UAAM,KAAK,KAAM;AAEjB,UAAM,MAAM,KAAK,IAAK;AACtB,UAAM,eAAe,OAAO,OAAO,WAAS;AAC1C,YAAM,aAAY,oBAAI,KAAK,GAAG,MAAM,SAAS,IAAI,MAAM,aAAa,OAAO,EAAE,GAAE,QAAS;AACxF,aAAO,YAAY,OAAO,CAAC,MAAM;AAAA,IACvC,CAAK;AAED,eAAW,SAAS,cAAc;AAChC,UAAI;AACF,cAAM,KAAK,wBAAwB,KAAK;AAAA,MACzC,SAAQ,OAAO;AACdA,sBAAA,MAAA,MAAA,SAAA,4BAAc,aAAa,MAAM,OAAO,KAAK;AAAA,MAC9C;AAAA,IACF;AAAA,EACF;AACH;AAEA,MAAA,kBAAe,IAAI,gBAAe;;"}
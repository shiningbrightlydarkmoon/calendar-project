{"version":3,"file":"reminder.js","sources":["utils/reminder.js"],"sourcesContent":["// utils/reminder.js\n\nclass ReminderService {\n  constructor() {\n    this.initialized = false;\n  }\n\n  /**\n   * åˆå§‹åŒ–æé†’æœåŠ¡\n   * åœ¨ App.vue çš„ onLaunch ä¸­è°ƒç”¨ï¼Œç¡®ä¿ç”³è¯·åˆ°ç³»ç»Ÿé€šçŸ¥æƒé™\n   */\n  async init() {\n    if (this.initialized) return;\n    \n    // #ifdef APP-PLUS\n    try {\n      // ç”³è¯·å®‰å“é€šçŸ¥æƒé™ï¼ˆé€‚é… Android 13+ï¼‰\n      plus.push.requestPermission((res) => {\n        console.log('ğŸ”” [System] é€šçŸ¥æƒé™çŠ¶æ€:', res);\n        this.initialized = true;\n      });\n    } catch (error) {\n      console.error('âŒ æé†’æœåŠ¡æƒé™åˆå§‹åŒ–å¤±è´¥:', error);\n    }\n    // #endif\n    \n    // #ifndef APP-PLUS\n    this.initialized = true;\n    // #endif\n  }\n\n  /**\n   * åˆ›å»ºæœ¬åœ°é€šçŸ¥\n   * @param {Object} rawEvent - æ—¥ç¨‹æ•°æ®ï¼ˆè‡ªåŠ¨å…¼å®¹åŒ…å« data å­—æ®µçš„å¯¹è±¡ï¼‰\n   */\n  createLocalNotification(rawEvent) {\n    return new Promise((resolve) => {\n      // 1. è‡ªåŠ¨å…¼å®¹åµŒå¥—å±‚çº§ï¼šæå–æ ¸å¿ƒæ—¥ç¨‹æ•°æ®\n      const event = (rawEvent && rawEvent.data) ? rawEvent.data : rawEvent;\n\n      // 2. å¢å¼ºæ ¡éªŒï¼šç¡®ä¿æ ‡é¢˜å’Œæ—¥æœŸæ ¼å¼æ­£ç¡®\n      if (!event || !event.title || !event.startDate) {\n        console.warn('âš ï¸ [Reminder] æ•°æ®ä¸å®Œæ•´ï¼Œå¿½ç•¥æé†’è®¾ç½®:', {\n          receivedData: event,\n          hasTitle: !!event?.title,\n          hasStartDate: !!event?.startDate\n        });\n        return resolve();\n      }\n\n      // #ifdef APP-PLUS\n      if (!plus.push) return resolve();\n\n      // 3. è®¡ç®—æé†’æ—¶é—´ä¸å»¶æ—¶\n      const reminderTime = this.calculateReminderTime(event);\n      const now = Date.now();\n      const delay = reminderTime - now;\n\n      // 4. æ„é€ é€šçŸ¥å†…å®¹ï¼ˆå¼ºåˆ¶å­—ç¬¦ä¸²åŒ–ï¼Œè§£å†³ undefined æŠ¥é”™ï¼‰\n      const content = String(event.title); \n      const payload = JSON.stringify({ id: event._id, type: 'calendar_event' });\n      \n      const options = {\n        title: 'æ—¥ç¨‹æé†’',\n        cover: false,\n        sound: 'system',\n        when: new Date(reminderTime) // ç³»ç»Ÿçº§å®šæ—¶æ’æœŸ\n      };\n\n      // 5. æ‰§è¡Œæé†’ï¼šä½¿ç”¨è®¡æ—¶å™¨ä½œä¸ºåº”ç”¨å†…å­˜é©»ç•™æœŸé—´çš„åŒé‡ä¿é™©\n      if (delay <= 0) {\n        // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œç«‹å³å¼¹å‡ºéªŒè¯åŠŸèƒ½\n        plus.push.createMessage(content, payload, options);\n        console.log('ğŸš€ [Reminder] ç«‹å³è§¦å‘é€šçŸ¥:', content);\n      } else if (delay < 24 * 60 * 60 * 1000) { \n        // 24å°æ—¶å†…çš„æ—¥ç¨‹ï¼Œè®¾ç½®è®¡æ—¶å™¨å‡†æ—¶å‘¼å«ç³»ç»Ÿæ¨é€æ¥å£\n        setTimeout(() => {\n          try {\n            plus.push.createMessage(content, payload, options);\n            console.log('ğŸš€ [Reminder] åˆ°ç‚¹è§¦å‘:', content);\n          } catch (e) {\n            console.error('âŒ [Reminder] æ¨é€å¤±è´¥:', e);\n          }\n        }, delay);\n        \n        console.log(`âœ… [Reminder] æé†’æ’æœŸæˆåŠŸ: \"${content}\"ï¼Œé¢„è®¡äº ${new Date(reminderTime).toLocaleString()} å¼¹å‡º`);\n      }\n      // #endif\n      \n      // #ifdef H5\n      this.createH5Notification(event, reminderTime).then(resolve);\n      // #endif\n      \n      // #ifdef MP-WEIXIN\n      // å¾®ä¿¡å°ç¨‹åºä¸æ”¯æŒ plus.pushï¼Œéœ€é€šè¿‡è®¢é˜…æ¶ˆæ¯å®ç°ï¼Œæ­¤å¤„é™é»˜å¤„ç†ä»¥é˜²æŠ¥é”™\n      resolve();\n      // #endif\n    });\n  }\n\n  /**\n   * è®¡ç®—æé†’æ—¶é—´ï¼šé»˜è®¤æå‰ 15 åˆ†é’Ÿ\n   */\n  calculateReminderTime(event) {\n    try {\n      // å…¼å®¹æ ¼å¼ï¼šå°† \"2025-12-22\" è½¬æ¢ä¸º \"2025/12/22\" ä»¥æ”¯æŒæ‰€æœ‰å†…æ ¸\n      const dateStr = event.startDate.replace(/-/g, '/');\n      const timeStr = event.startTime || '00:00';\n      const startDateTime = new Date(`${dateStr} ${timeStr}`);\n      \n      // é»˜è®¤æå‰ 15 åˆ†é’Ÿ\n      const advanceMS = 15 * 60 * 1000; \n      return startDateTime.getTime() - advanceMS;\n    } catch (e) {\n      console.error('âŒ [Reminder] æ—¶é—´è§£æå‡ºé”™:', e);\n      return Date.now() + 5000; // å¤±è´¥åˆ™5ç§’åå…œåº•å¼¹å‡º\n    }\n  }\n\n  /**\n   * æ¸…é™¤æ‰€æœ‰æœ¬åœ°é€šçŸ¥è®°å½•\n   */\n  cancelNotification() {\n    // #ifdef APP-PLUS\n    if (typeof plus !== 'undefined' && plus.push) {\n      plus.push.clear();\n      console.log('ğŸ—‘ï¸ [Reminder] æœ¬åœ°é€šçŸ¥æ å·²æ¸…ç©º');\n    }\n    // #endif\n  }\n\n  /**\n   * H5 æµè§ˆå™¨é€šçŸ¥å®ç°\n   */\n  async createH5Notification(event, reminderTime) {\n    if ('Notification' in window && Notification.permission === 'granted') {\n      const delay = reminderTime - Date.now();\n      if (delay > 0) {\n        setTimeout(() => {\n          new Notification('æ—¥ç¨‹æé†’', { body: event.title });\n        }, delay);\n      }\n    }\n  }\n}\n\nexport default new ReminderService();"],"names":["uni"],"mappings":";;AAEA,MAAM,gBAAgB;AAAA,EACpB,cAAc;AACZ,SAAK,cAAc;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA;AAAA,EAMD,MAAM,OAAO;AACX,QAAI,KAAK;AAAa;AAetB,SAAK,cAAc;AAAA,EAEpB;AAAA;AAAA;AAAA;AAAA;AAAA,EAMD,wBAAwB,UAAU;AAChC,WAAO,IAAI,QAAQ,CAAC,YAAY;AAE9B,YAAM,QAAS,YAAY,SAAS,OAAQ,SAAS,OAAO;AAG5D,UAAI,CAAC,SAAS,CAAC,MAAM,SAAS,CAAC,MAAM,WAAW;AAC9CA,sBAAAA,MAAA,MAAA,QAAA,2BAAa,+BAA+B;AAAA,UAC1C,cAAc;AAAA,UACd,UAAU,CAAC,EAAC,+BAAO;AAAA,UACnB,cAAc,CAAC,EAAC,+BAAO;AAAA,QACjC,CAAS;AACD,eAAO,QAAO;AAAA,MACf;AA+CD;IAEN,CAAK;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKD,sBAAsB,OAAO;AAC3B,QAAI;AAEF,YAAM,UAAU,MAAM,UAAU,QAAQ,MAAM,GAAG;AACjD,YAAM,UAAU,MAAM,aAAa;AACnC,YAAM,gBAAgB,oBAAI,KAAK,GAAG,OAAO,IAAI,OAAO,EAAE;AAGtD,YAAM,YAAY,KAAK,KAAK;AAC5B,aAAO,cAAc,QAAS,IAAG;AAAA,IAClC,SAAQ,GAAG;AACVA,oBAAc,MAAA,MAAA,SAAA,4BAAA,wBAAwB,CAAC;AACvC,aAAO,KAAK,IAAK,IAAG;AAAA,IACrB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKD,qBAAqB;AAAA,EAOpB;AAAA;AAAA;AAAA;AAAA,EAKD,MAAM,qBAAqB,OAAO,cAAc;AAC9C,QAAI,kBAAkB,UAAU,aAAa,eAAe,WAAW;AACrE,YAAM,QAAQ,eAAe,KAAK,IAAG;AACrC,UAAI,QAAQ,GAAG;AACb,mBAAW,MAAM;AACf,cAAI,aAAa,QAAQ,EAAE,MAAM,MAAM,MAAK,CAAE;AAAA,QAC/C,GAAE,KAAK;AAAA,MACT;AAAA,IACF;AAAA,EACF;AACH;AAEA,MAAe,kBAAA,IAAI,gBAAiB;;"}